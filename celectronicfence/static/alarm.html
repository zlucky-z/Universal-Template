<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>告警管理</title>
    <link rel="stylesheet" href="bootstrap.min.css">
    <link rel="stylesheet" href="fontawesome-all.min.css">
    <script src="axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 95%;
            width: 100%;
            margin: 0 auto;
        }
        
        @media (min-width: 1400px) {
            .container {
                max-width: 1800px;
            }
        }

        /* 头部区域 */
        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-title i {
            color: #ff5252;
            font-size: 28px;
        }

        /* 搜索筛选区域 */
        .filter-bar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
            overflow: hidden;
        }

        .filter-row {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding-bottom: 10px;
            scrollbar-width: thin;
            scrollbar-color: #667eea #f0f0f0;
        }

        /* 美化滚动条（Webkit浏览器） */
        .filter-row::-webkit-scrollbar {
            height: 6px;
        }

        .filter-row::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 3px;
        }

        .filter-row::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 3px;
            transition: background 0.3s;
        }

        .filter-row::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 150px;
            flex-shrink: 0;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            white-space: nowrap;
        }

        .filter-select, .filter-input {
            padding: 9px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            margin-left: auto;
            flex-shrink: 0;
            padding-left: 15px;
        }

        .btn {
            padding: 9px 20px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            height: 38px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #666;
        }

        /* 告警卡片网格 */
        .alarm-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .alarm-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .alarm-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.2);
        }

        .alarm-card:hover .alarm-image::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, transparent 0%, rgba(0, 0, 0, 0.1) 100%);
            pointer-events: none;
        }

        .alarm-image {
            position: relative;
            width: 100%;
            height: 250px;
            overflow: hidden;
            background: #f0f0f0;
        }

        .alarm-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .alarm-time-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .alarm-type-badge {
            position: absolute;
            top: 10px;  /* 与复选框同一高度 */
            left: 38px;  /* 紧挨着复选框 */
            background: linear-gradient(135deg, #ff5252 0%, #f48fb1 100%);
            color: white;
            padding: 4px 10px;  /* 缩小内边距 */
            border-radius: 5px;
            font-size: 11px;  /* 稍微缩小字体 */
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 8px rgba(255, 82, 82, 0.3);
            line-height: 1.2;
        }

        .alarm-content {
            padding: 15px;
        }

        .alarm-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .alarm-source {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-size: 13px;
        }

        .alarm-source i {
            color: #667eea;
        }

        .alarm-date {
            color: #999;
            font-size: 12px;
        }

        .alarm-details {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #f0f0f0;
        }

        .alarm-detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .alarm-detail-item i {
            color: #999;
            width: 16px;
        }

        .alarm-detail-item span {
            color: #666;
        }

        /* 标签 */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* 操作按钮 */
        .alarm-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .batch-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff5252 0%, #f48fb1 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 82, 82, 0.4);
        }

        .alarm-checkbox {
            position: absolute;
            top: 12px;
            left: 10px;
            width: 18px;  /* 缩小复选框 */
            height: 18px;
            cursor: pointer;
            z-index: 10;
            accent-color: #667eea;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 3px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
            transition: all 0.2s;
        }

        .alarm-checkbox:hover {
            transform: scale(1.15);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .alarm-card.selected {
            border: 3px solid #667eea;
        }

        .delete-btn {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: rgba(255, 82, 82, 0.95);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
            z-index: 10;
            opacity: 0;  /* 默认隐藏 */
            transform: translateY(10px);  /* 默认位置稍微下移 */
            pointer-events: none;  /* 隐藏时不可点击 */
        }

        .alarm-card:hover .delete-btn {
            opacity: 1;  /* 悬停时显示 */
            transform: translateY(0);  /* 悬停时回到正常位置 */
            pointer-events: auto;  /* 显示时可点击 */
        }

        .delete-btn:hover {
            background: #ff1744;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 23, 68, 0.4);
        }

        /* 分页 */
        .pagination {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .pagination-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .pagination-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .goto-text {
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .goto-input {
            width: 70px;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
            transition: all 0.3s;
            outline: none;
        }

        .goto-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .goto-input:hover {
            border-color: #667eea;
        }

        .goto-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }

        .goto-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .clear-btn {
            background: linear-gradient(135deg, #ff5252 0%, #f48fb1 100%);
            color: white;
            border: none;
            margin-left: 10px;
        }

        .clear-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 82, 82, 0.4);
        }

        /* 响应式筛选栏布局 */
        @media (max-width: 1200px) {
            .filter-row {
                flex-wrap: wrap;
            }
            
            .filter-group {
                min-width: 140px;
            }
            
            .filter-actions {
                width: 100%;
                margin-left: 0;
                padding-left: 0;
                justify-content: flex-end;
                margin-top: 10px;
            }
        }

        /* 响应式分页布局 */
        @media (max-width: 768px) {
            .pagination {
                flex-direction: column;
                gap: 15px;
            }
            
            .pagination-left,
            .pagination-right {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .goto-input {
                width: 80px;
            }
            
            .filter-group {
                min-width: 120px;
            }
            
            .clear-btn {
                margin-left: 0;
                margin-top: 10px;
                width: 100%;
            }
        }

        .page-btn {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            color: #666;
            font-size: 14px;
        }

        .page-btn:hover:not(:disabled) {
            border-color: #667eea;
            color: #667eea;
        }

        .page-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-info {
            color: #666;
            font-size: 14px;
            padding: 0 15px;
        }

        /* 空状态 */
        .empty-state {
            background: white;
            border-radius: 12px;
            padding: 80px 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .empty-state i {
            font-size: 64px;
            color: #ddd;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 18px;
            color: #666;
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 14px;
            color: #999;
        }

        /* 详情模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .btn-close {
            background: transparent;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .btn-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        .modal-body {
            padding: 30px;
        }

        .modal-image {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .detail-section {
            margin-bottom: 20px;
        }

        .detail-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-title i {
            color: #667eea;
        }

        .detail-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            color: #666;
            line-height: 1.6;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- 头部 -->
        <div class="header">
            <div class="header-title">
                <i class="fas fa-bell"></i>
                告警管理
            </div>
        </div>

        <!-- 筛选栏 -->
        <div class="filter-bar">
            <div class="filter-row">
                <div class="filter-group">
                    <label class="filter-label">告警任务</label>
                    <select class="filter-select" id="filterTask">
                        <option value="">全部任务</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">视频源道</label>
                    <select class="filter-select" id="filterSource">
                        <option value="">全部视频源</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">告警日期</label>
                    <input type="date" class="filter-input" id="filterDate">
                </div>
                <div class="filter-group">
                    <label class="filter-label">告警内容</label>
                    <input type="text" class="filter-input" id="filterContent" placeholder="搜索告警内容">
                </div>
                <div class="filter-group">
                    <label class="filter-label">告警状态</label>
                    <select class="filter-select" id="filterStatus">
                        <option value="">全部状态</option>
                        <option value="reported">已上报</option>
                        <option value="failed">上报失败</option>
                        <option value="pending">未上报</option>
                    </select>
                </div>
                <div class="filter-actions">
                    <button class="btn btn-primary" onclick="searchAlarms()">
                        <i class="fas fa-search"></i>
                        查询
                    </button>
                    <button class="btn btn-secondary" onclick="resetFilters()">
                        <i class="fas fa-redo"></i>
                        重置
                    </button>
                </div>
            </div>
        </div>

        <!-- 批量操作栏 -->
        <div class="alarm-actions">
            <div class="batch-actions">
                <button class="btn btn-danger" onclick="batchDelete()" id="batchDeleteBtn" style="display: none;">
                    <i class="fas fa-trash"></i>
                    批量删除 (<span id="selectedCount">0</span>)
                </button>
            </div>
        </div>

        <!-- 告警卡片网格 -->
        <div class="alarm-grid" id="alarmGrid">
            <!-- 动态加载 -->
        </div>

        <!-- 空状态 -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <i class="fas fa-bell-slash"></i>
            <h3>暂无告警记录</h3>
            <p>当前没有符合条件的告警信息</p>
        </div>

        <!-- 分页 -->
        <div class="pagination" id="pagination" style="display: none;">
            <div class="pagination-left">
                <button class="page-btn" id="firstPage" onclick="goToFirstPage()" title="首页">
                    <i class="fas fa-angle-double-left"></i>
                </button>
                <button class="page-btn" id="prevPage" onclick="changePage(-1)" title="上一页">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <span class="page-info" id="pageInfo">第 1 页 / 共 1 页</span>
                <button class="page-btn" id="nextPage" onclick="changePage(1)" title="下一页">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <button class="page-btn" id="lastPage" onclick="goToLastPage()" title="末页">
                    <i class="fas fa-angle-double-right"></i>
                </button>
            </div>
            <div class="pagination-right">
                <span class="goto-text">跳转到</span>
                <input type="number" 
                       id="gotoPageInput" 
                       class="goto-input" 
                       min="1" 
                       placeholder="页码"
                       onkeypress="handlePageInputKeypress(event)">
                <button class="page-btn goto-btn" onclick="gotoPage()" title="跳转">
                    <i class="fas fa-arrow-right"></i>
                </button>
                <button class="page-btn clear-btn" onclick="clearAllRecords()" title="清除所有记录">
                    <i class="fas fa-trash-alt"></i>
                    清除记录
                </button>
            </div>
        </div>
    </div>

    <!-- 详情模态框 -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">告警详情</div>
                <button class="btn-close" onclick="closeDetailModal()">×</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- 动态加载 -->
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let alarms = [];
        let filteredAlarms = [];
        let currentPage = 1;
        let pageSize = 12;
        let totalPages = 1;
        let selectedAlarms = new Set(); // 存储选中的告警ID
        let autoRefreshInterval = null; // 自动刷新定时器

        // 页面加载时获取数据
        window.onload = function() {
            loadTasks();
            loadVideoSources();
            loadAlarms();
            // 启动自动刷新（每5秒刷新一次）
            startAutoRefresh();
        };

        // 启动自动刷新
        function startAutoRefresh() {
            autoRefreshInterval = setInterval(() => {
                loadAlarms(true); // 静默刷新，不重置页码
            }, 5000);
        }

        // 停止自动刷新
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // 页面卸载时停止自动刷新
        window.addEventListener('beforeunload', () => {
            stopAutoRefresh();
        });

        // 加载任务列表
        function loadTasks() {
            axios.get('/api/tasks')
                .then(response => {
                    if (response.data.status === 'success') {
                        const tasks = response.data.tasks || [];
                        const select = document.getElementById('filterTask');
                        tasks.forEach(task => {
                            const option = document.createElement('option');
                            option.value = task.id;
                            option.textContent = task.taskNumber;
                            select.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('加载任务列表失败:', error);
                });
        }

        // 加载视频源列表
        function loadVideoSources() {
            axios.get('/api/channels')
                .then(response => {
                    if (response.data.status === 'success') {
                        const channels = response.data.channels || [];
                        const select = document.getElementById('filterSource');
                        channels.forEach(channel => {
                            const option = document.createElement('option');
                            option.value = channel.id;
                            option.textContent = channel.name;
                            select.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('加载视频源列表失败:', error);
                });
        }

        // 加载告警列表
        function loadAlarms(silent = false) {
            axios.get('/api/alarms')
                .then(response => {
                    if (response.data.status === 'success') {
                        alarms = response.data.alarms || [];
                        // 如果不是静默刷新，重新应用筛选和重置页码
                        if (!silent) {
                            filteredAlarms = [...alarms];
                        } else {
                            // 静默刷新时保持当前筛选条件
                            applyCurrentFilters();
                        }
                        renderAlarms();
                    }
                })
                .catch(error => {
                    console.error('加载告警失败:', error);
                    if (!silent) {
                        alarms = [];
                        filteredAlarms = [];
                        renderAlarms();
                    }
                });
        }

        // 应用当前筛选条件
        function applyCurrentFilters() {
            const taskId = document.getElementById('filterTask').value;
            const sourceId = document.getElementById('filterSource').value;
            const date = document.getElementById('filterDate').value;
            const content = document.getElementById('filterContent').value.toLowerCase();
            const status = document.getElementById('filterStatus').value;

            filteredAlarms = alarms.filter(alarm => {
                if (taskId && alarm.taskId != taskId) return false;
                if (sourceId && alarm.videoSourceId != sourceId) return false;
                if (date && !alarm.timestamp.startsWith(date)) return false;
                if (content && !alarm.alarmType.toLowerCase().includes(content)) return false;
                if (status && alarm.status !== status) return false;
                return true;
            });
        }

        // 搜索告警
        function searchAlarms() {
            const taskId = document.getElementById('filterTask').value;
            const sourceId = document.getElementById('filterSource').value;
            const date = document.getElementById('filterDate').value;
            const content = document.getElementById('filterContent').value.toLowerCase();
            const status = document.getElementById('filterStatus').value;

            filteredAlarms = alarms.filter(alarm => {
                if (taskId && alarm.taskId != taskId) return false;
                if (sourceId && alarm.videoSourceId != sourceId) return false;
                if (date && !alarm.timestamp.startsWith(date)) return false;
                if (content && !alarm.alarmType.toLowerCase().includes(content)) return false;
                if (status && alarm.status !== status) return false;
                return true;
            });

            currentPage = 1;
            renderAlarms();
        }

        // 重置筛选
        function resetFilters() {
            document.getElementById('filterTask').value = '';
            document.getElementById('filterSource').value = '';
            document.getElementById('filterDate').value = '';
            document.getElementById('filterContent').value = '';
            document.getElementById('filterStatus').value = '';
            filteredAlarms = [...alarms];
            currentPage = 1;
            renderAlarms();
        }

        // 渲染告警列表
        function renderAlarms() {
            const grid = document.getElementById('alarmGrid');
            const emptyState = document.getElementById('emptyState');
            const pagination = document.getElementById('pagination');

            if (filteredAlarms.length === 0) {
                grid.innerHTML = '';
                emptyState.style.display = 'block';
                pagination.style.display = 'none';
                updateSelectedCount();
                return;
            }

            emptyState.style.display = 'none';
            pagination.style.display = 'flex';

            // 计算分页
            totalPages = Math.ceil(filteredAlarms.length / pageSize);
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredAlarms.length);
            const pageAlarms = filteredAlarms.slice(startIndex, endIndex);

            // 渲染卡片
            grid.innerHTML = pageAlarms.map(alarm => `
                <div class="alarm-card ${selectedAlarms.has(alarm.id) ? 'selected' : ''}" id="alarm-${alarm.id}">
                    <input type="checkbox" 
                           class="alarm-checkbox" 
                           ${selectedAlarms.has(alarm.id) ? 'checked' : ''}
                           onclick="toggleSelection(event, ${alarm.id})">
                    <div class="alarm-image" onclick="showDetailModal(${alarm.id})">
                        <img src="${alarm.imageUrl}" alt="告警图片" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0iI2YwZjBmMCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7ml6Dlm77niYc8L3RleHQ+PC9zdmc+'">
                        <div class="alarm-time-badge">
                            <i class="fas fa-clock"></i>
                            ${formatTime(alarm.timestamp)}
                        </div>
                        <div class="alarm-type-badge">
                            <i class="fas fa-exclamation-triangle"></i>
                            ${alarm.alarmType}
                        </div>
                    </div>
                    <div class="alarm-content" onclick="showDetailModal(${alarm.id})">
                        <div class="alarm-info-row">
                            <div class="alarm-source">
                                <i class="fas fa-video"></i>
                                <span>${alarm.videoSourceName || '未知'}</span>
                            </div>
                            <div class="alarm-date">${formatDate(alarm.timestamp)}</div>
                        </div>
                        <div class="alarm-details">
                            <div class="alarm-detail-item">
                                <i class="fas fa-link"></i>
                                <span>${alarm.reportUrl || '无上报地址'}</span>
                            </div>
                            <div class="alarm-detail-item">
                                <i class="fas fa-info-circle"></i>
                                <span>${getStatusBadge(alarm.status)}</span>
                            </div>
                            <div class="alarm-detail-item">
                                <i class="fas fa-tag"></i>
                                <span>${getAlarmContentBadge(alarm.alarmType)}</span>
                            </div>
                        </div>
                    </div>
                    <button class="delete-btn" onclick="deleteSingleAlarm(event, ${alarm.id})">
                        <i class="fas fa-trash"></i> 删除
                    </button>
                </div>
            `).join('');

            // 更新分页信息和选中计数
            updatePagination();
            updateSelectedCount();
        }

        // 获取状态徽章HTML
        function getStatusBadge(status) {
            const statusMap = {
                'reported': '<span class="badge badge-success"><i class="fas fa-check-circle"></i> 已上报</span>',
                'failed': '<span class="badge badge-danger"><i class="fas fa-times-circle"></i> 上报失败</span>',
                'pending': '<span class="badge badge-info"><i class="fas fa-clock"></i> 未上报</span>'
            };
            return statusMap[status] || '<span class="badge badge-info">未知状态</span>';
        }

        // 获取告警内容徽章HTML
        function getAlarmContentBadge(type) {
            return `<span class="badge badge-warning">${type}</span>`;
        }

        // 格式化时间（仅时间）
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        // 格式化日期
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // 更新分页
        function updatePagination() {
            document.getElementById('pageInfo').textContent = `第 ${currentPage} 页 / 共 ${totalPages} 页`;
            
            // 更新所有分页按钮的状态
            const isFirstPage = currentPage === 1;
            const isLastPage = currentPage === totalPages;
            
            document.getElementById('firstPage').disabled = isFirstPage;
            document.getElementById('prevPage').disabled = isFirstPage;
            document.getElementById('nextPage').disabled = isLastPage;
            document.getElementById('lastPage').disabled = isLastPage;
            
            // 更新输入框的最大值提示
            const gotoInput = document.getElementById('gotoPageInput');
            gotoInput.max = totalPages;
            gotoInput.placeholder = `1-${totalPages}`;
        }

        // 切换页码
        function changePage(delta) {
            const newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderAlarms();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // 跳转到首页
        function goToFirstPage() {
            if (currentPage !== 1) {
                currentPage = 1;
                renderAlarms();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // 跳转到末页
        function goToLastPage() {
            if (currentPage !== totalPages) {
                currentPage = totalPages;
                renderAlarms();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // 跳转到指定页码
        function gotoPage() {
            const input = document.getElementById('gotoPageInput');
            const pageNum = parseInt(input.value);
            
            if (isNaN(pageNum)) {
                alert('请输入有效的页码');
                return;
            }
            
            if (pageNum < 1) {
                alert('页码不能小于 1');
                input.value = '';
                return;
            }
            
            if (pageNum > totalPages) {
                alert(`页码不能大于 ${totalPages}`);
                input.value = '';
                return;
            }
            
            currentPage = pageNum;
            renderAlarms();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            input.value = '';
        }

        // 处理输入框回车事件
        function handlePageInputKeypress(event) {
            if (event.key === 'Enter') {
                gotoPage();
            }
        }

        // 清除所有记录
        function clearAllRecords() {
            if (!allAlarms || allAlarms.length === 0) {
                alert('当前没有记录可清除');
                return;
            }
            
            if (!confirm(`确定要清除所有 ${allAlarms.length} 条告警记录吗？此操作不可恢复！`)) {
                return;
            }
            
            // 获取所有记录的ID
            const allIds = allAlarms.map(alarm => alarm.id);
            
            // 调用批量删除API
            axios.post('/api/alarms/batch-delete', {
                ids: allIds
            })
                .then(response => {
                    console.log('清除成功:', response.data);
                    alert('所有记录已清除');
                    // 清空本地数据
                    allAlarms = [];
                    filteredAlarms = [];
                    selectedAlarms.clear();
                    currentPage = 1;
                    // 重新渲染（会显示空状态）
                    renderAlarms();
                })
                .catch(error => {
                    console.error('清除失败:', error);
                    alert('清除失败，请重试');
                });
        }

        // 显示详情模态框
        function showDetailModal(alarmId) {
            const alarm = filteredAlarms.find(a => a.id === alarmId);
            if (!alarm) return;

            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <img src="${alarm.imageUrl}" class="modal-image" alt="告警图片" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNzAwIiBoZWlnaHQ9IjQwMCIgZmlsbD0iI2YwZjBmMCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjAiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7ml6Dlm77niYc8L3RleHQ+PC9zdmc+'">
                
                <div class="detail-section">
                    <div class="detail-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        告警类型
                    </div>
                    <div class="detail-content">${alarm.alarmType}</div>
                </div>

                <div class="detail-section">
                    <div class="detail-title">
                        <i class="fas fa-video"></i>
                        视频源
                    </div>
                    <div class="detail-content">${alarm.videoSourceName || '未知'}</div>
                </div>

                <div class="detail-section">
                    <div class="detail-title">
                        <i class="fas fa-clock"></i>
                        告警时间
                    </div>
                    <div class="detail-content">${formatDate(alarm.timestamp)}</div>
                </div>

                <div class="detail-section">
                    <div class="detail-title">
                        <i class="fas fa-link"></i>
                        上报地址
                    </div>
                    <div class="detail-content">${alarm.reportUrl || '无'}</div>
                </div>

                <div class="detail-section">
                    <div class="detail-title">
                        <i class="fas fa-info-circle"></i>
                        上报状态
                    </div>
                    <div class="detail-content">${getStatusBadge(alarm.status)}</div>
                </div>

                ${alarm.description ? `
                <div class="detail-section">
                    <div class="detail-title">
                        <i class="fas fa-file-alt"></i>
                        详细描述
                    </div>
                    <div class="detail-content">${alarm.description}</div>
                </div>
                ` : ''}
            `;

            document.getElementById('detailModal').classList.add('show');
        }

        // 关闭详情模态框
        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('show');
        }

        // 点击模态框外部关闭
        document.getElementById('detailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDetailModal();
            }
        });

        // 切换选择状态
        function toggleSelection(event, alarmId) {
            event.stopPropagation(); // 阻止事件冒泡到卡片
            const card = document.getElementById(`alarm-${alarmId}`);
            
            if (selectedAlarms.has(alarmId)) {
                selectedAlarms.delete(alarmId);
                card.classList.remove('selected');
            } else {
                selectedAlarms.add(alarmId);
                card.classList.add('selected');
            }
            
            updateSelectedCount();
        }

        // 更新选中计数
        function updateSelectedCount() {
            const count = selectedAlarms.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('batchDeleteBtn').style.display = count > 0 ? 'inline-flex' : 'none';
        }

        // 删除单个告警
        function deleteSingleAlarm(event, alarmId) {
            event.stopPropagation(); // 阻止事件冒泡到卡片
            
            if (!confirm('确定要删除这条告警记录吗？')) {
                return;
            }

            axios.delete(`/api/alarms/${alarmId}`)
                .then(response => {
                    if (response.data.status === 'success') {
                        // 从选中集合中移除
                        selectedAlarms.delete(alarmId);
                        // 重新加载告警列表
                        loadAlarms(false);
                    } else {
                        alert('删除失败：' + (response.data.message || '未知错误'));
                    }
                })
                .catch(error => {
                    console.error('删除失败:', error);
                    alert('删除失败，请重试');
                });
        }

        // 批量删除告警
        function batchDelete() {
            if (selectedAlarms.size === 0) {
                alert('请先选择要删除的告警');
                return;
            }

            if (!confirm(`确定要删除选中的 ${selectedAlarms.size} 条告警记录吗？`)) {
                return;
            }

            const idsToDelete = Array.from(selectedAlarms);

            axios.post('/api/alarms/batch-delete', { ids: idsToDelete })
                .then(response => {
                    if (response.data.status === 'success') {
                        // 清空选中集合
                        selectedAlarms.clear();
                        // 重新加载告警列表
                        loadAlarms(false);
                        alert('批量删除成功');
                    } else {
                        alert('删除失败：' + (response.data.message || '未知错误'));
                    }
                })
                .catch(error => {
                    console.error('批量删除失败:', error);
                    alert('批量删除失败，请重试');
                });
        }

    </script>
</body>

</html>