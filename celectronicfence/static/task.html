<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任务管理</title>
    <link rel="stylesheet" href="bootstrap.min.css">
    <link rel="stylesheet" href="fontawesome-all.min.css">
    <script src="axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 95%;
            width: 100%;
            margin: 0 auto;
        }
        
        @media (min-width: 1400px) {
            .container {
                max-width: 1800px;
            }
        }

        /* 头部区域 */
        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-title i {
            color: #4a9eff;
            font-size: 28px;
        }

        .btn-add {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        /* 任务列表 */
        .tasks-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .tasks-table {
            width: 100%;
            border-collapse: collapse;
        }

        .tasks-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tasks-table th {
            padding: 18px 20px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tasks-table tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .tasks-table tbody tr:hover {
            background: #f8f9ff;
        }

        .tasks-table td {
            padding: 18px 20px;
            color: #666;
        }

        .task-name {
            font-weight: 600;
            color: #333;
            font-size: 15px;
        }

        /* 状态标签 */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-running {
            background: #d4edda;
            color: #155724;
        }

        .status-stopped {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge i {
            font-size: 8px;
        }

        /* 操作按钮 */
        .action-btns {
            display: flex;
            gap: 8px;
        }

        .btn-action {
            border: none;
            background: transparent;
            color: #666;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.2s;
            font-size: 14px;
        }

        .btn-start:hover {
            background: #d4edda;
            color: #28a745;
        }

        .btn-stop:hover {
            background: #fff3cd;
            color: #ffc107;
        }

        .btn-edit:hover {
            background: #e3f2fd;
            color: #1976d2;
        }

        .btn-delete:hover {
            background: #ffebee;
            color: #d32f2f;
        }

        /* 模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease;
            margin: 20px;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-title i {
            color: #667eea;
        }

        .btn-close {
            background: transparent;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .btn-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        .modal-body {
            padding: 30px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }

        .form-control, .form-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-control:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-select {
            background: white;
            cursor: pointer;
        }

        /* 算法选择 */
        .algorithm-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .algorithm-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .algorithm-card:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .algorithm-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .algorithm-card i {
            font-size: 32px;
            margin-bottom: 10px;
            display: block;
        }

        .algorithm-card.selected i {
            color: white;
        }

        .algorithm-name {
            font-size: 13px;
            font-weight: 500;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #999;
        }

        .empty-state i {
            font-size: 64px;
            color: #ddd;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 18px;
            color: #666;
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 14px;
            color: #999;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- 头部 -->
        <div class="header">
            <div class="header-title">
                <i class="fas fa-tasks"></i>
                任务管理
            </div>
            <button class="btn-add" onclick="openAddModal()">
                <i class="fas fa-plus"></i>
                新增任务
            </button>
        </div>

        <!-- 任务列表 -->
        <div class="tasks-container">
            <table class="tasks-table">
                <thead>
                    <tr>
                        <th>任务编号</th>
                        <th>任务描述</th>
                        <th>视频源</th>
                        <th>算法</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="tasksTableBody">
                    <!-- 动态加载 -->
                </tbody>
            </table>
            <div id="emptyState" class="empty-state" style="display: none;">
                <i class="fas fa-clipboard-list"></i>
                <h3>暂无任务</h3>
                <p>点击右上角"新增任务"按钮创建您的第一个任务</p>
            </div>
        </div>
    </div>

    <!-- 新增/编辑任务模态框 -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-plus-circle"></i>
                    <span id="modalTitle">新增任务</span>
                </div>
                <button class="btn-close" onclick="closeModal()">×</button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <!-- 基本配置 -->
                    <div class="section-title">基本配置</div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">任务编号</label>
                            <input type="text" class="form-control" id="taskNumber" placeholder="例如：TASK001" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">视频源</label>
                            <select class="form-select" id="taskVideoSource" required>
                                <option value="">请选择视频源</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label">任务描述</label>
                        <input type="text" class="form-control" id="taskDescription" placeholder="描述此任务的用途">
                    </div>

                    <!-- 算法设置 -->
                    <div class="section-title">算法设置</div>
                    
                    <div class="algorithm-grid" id="algorithmGrid">
                        <div class="algorithm-card" data-algorithm="region_intrusion">
                            <i class="fas fa-shield-alt"></i>
                            <div class="algorithm-name">区域入侵</div>
                        </div>
                        <div class="algorithm-card" data-algorithm="person_detection">
                            <i class="fas fa-user-check"></i>
                            <div class="algorithm-name">人员检测</div>
                        </div>
                    </div>

                    <input type="hidden" id="taskId">
                    <input type="hidden" id="selectedAlgorithm">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">取消</button>
                <button class="btn btn-primary" onclick="saveTask()">确定</button>
            </div>
        </div>
    </div>

    <script>
        // 任务数据
        let tasks = [];
        let editingTaskId = null;
        let availableChannels = [];

        // 页面加载时获取任务列表和通道列表
        window.onload = function() {
            // 先加载通道列表，完成后再加载任务列表
            loadChannels().then(() => {
                loadTasks();
            });
        };

        // 加载通道列表
        function loadChannels() {
            return axios.get('/api/channels')
                .then(response => {
                    if (response.data.status === 'success') {
                        availableChannels = response.data.channels || [];
                        updateVideoSourceOptions();
                        console.log('通道列表加载完成:', availableChannels);
                    }
                })
                .catch(error => {
                    console.error('加载通道列表失败:', error);
                    availableChannels = [];
                });
        }

        // 更新视频源选项
        function updateVideoSourceOptions() {
            const select = document.getElementById('taskVideoSource');
            select.innerHTML = '<option value="">请选择视频源</option>';
            
            availableChannels.forEach(channel => {
                const option = document.createElement('option');
                option.value = channel.id;
                option.textContent = `${channel.name} (通道${channel.channelAssignment})`;
                select.appendChild(option);
            });
        }

        // 加载任务列表
        function loadTasks() {
            axios.get('/api/tasks')
                .then(response => {
                    if (response.data.status === 'success') {
                        tasks = response.data.tasks || [];
                        renderTasks();
                    }
                })
                .catch(error => {
                    console.error('加载任务失败:', error);
                    tasks = [];
                    renderTasks();
                });
        }

        // 渲染任务列表
        function renderTasks() {
            const tbody = document.getElementById('tasksTableBody');
            const emptyState = document.getElementById('emptyState');

            if (tasks.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            tbody.innerHTML = tasks.map(task => {
                const channel = availableChannels.find(c => c.id == task.videoSourceId);
                let channelName = '未知';
                
                if (channel) {
                    channelName = channel.name;
                } else if (availableChannels.length === 0) {
                    // 如果通道列表为空，说明还在加载中
                    channelName = '加载中...';
                    console.warn('通道列表为空，无法显示视频源名称');
                } else {
                    console.warn(`未找到ID为 ${task.videoSourceId} 的通道`);
                }
                
                return `
                <tr>
                    <td><span class="task-name">${task.taskNumber}</span></td>
                    <td>${task.description || '-'}</td>
                    <td>${channelName}</td>
                    <td>${getAlgorithmName(task.algorithm)}</td>
                    <td>
                        <span class="status-badge status-${task.status}">
                            <i class="fas fa-circle"></i>
                            ${getStatusText(task.status)}
                        </span>
                    </td>
                    <td>
                        <div class="action-btns">
                            ${task.status === 'stopped' ? 
                                `<button class="btn-action btn-start" onclick="startTask(${task.id})" title="启动">
                                    <i class="fas fa-play"></i>
                                </button>` : 
                                `<button class="btn-action btn-stop" onclick="stopTask(${task.id})" title="停止">
                                    <i class="fas fa-stop"></i>
                                </button>`
                            }
                            <button class="btn-action btn-edit" onclick="editTask(${task.id})" title="编辑">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-action btn-delete" onclick="deleteTask(${task.id})" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        // 获取算法名称
        function getAlgorithmName(algorithm) {
            const algorithmMap = {
                'region_intrusion': '区域入侵',
                'person_detection': '人员检测'
            };
            return algorithmMap[algorithm] || algorithm;
        }

        // 获取状态文本
        function getStatusText(status) {
            const statusMap = {
                'running': '运行中',
                'stopped': '已停止'
            };
            return statusMap[status] || '未知';
        }

        // 打开新增模态框
        function openAddModal() {
            editingTaskId = null;
            document.getElementById('modalTitle').textContent = '新增任务';
            document.getElementById('taskForm').reset();
            document.getElementById('taskId').value = '';
            document.getElementById('selectedAlgorithm').value = '';
            
            // 清除算法选择
            document.querySelectorAll('.algorithm-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            document.getElementById('taskModal').classList.add('show');
        }

        // 编辑任务
        function editTask(id) {
            const task = tasks.find(t => t.id === id);
            if (!task) return;

            editingTaskId = id;
            document.getElementById('modalTitle').textContent = '编辑任务';
            document.getElementById('taskNumber').value = task.taskNumber;
            document.getElementById('taskDescription').value = task.description || '';
            document.getElementById('taskVideoSource').value = task.videoSourceId;
            document.getElementById('selectedAlgorithm').value = task.algorithm;
            document.getElementById('taskId').value = id;
            
            // 选中对应的算法
            document.querySelectorAll('.algorithm-card').forEach(card => {
                if (card.getAttribute('data-algorithm') === task.algorithm) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
            
            document.getElementById('taskModal').classList.add('show');
        }

        // 关闭模态框
        function closeModal() {
            document.getElementById('taskModal').classList.remove('show');
        }

        // 算法卡片点击事件
        document.getElementById('algorithmGrid').addEventListener('click', (e) => {
            const card = e.target.closest('.algorithm-card');
            if (card) {
                document.querySelectorAll('.algorithm-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                document.getElementById('selectedAlgorithm').value = card.getAttribute('data-algorithm');
            }
        });

        // 保存任务
        function saveTask() {
            const taskNumber = document.getElementById('taskNumber').value.trim();
            const description = document.getElementById('taskDescription').value.trim();
            const videoSourceId = document.getElementById('taskVideoSource').value;
            const algorithm = document.getElementById('selectedAlgorithm').value;

            if (!taskNumber) {
                alert('请填写任务编号');
                return;
            }

            if (!videoSourceId) {
                alert('请选择视频源');
                return;
            }

            if (!algorithm) {
                alert('请选择算法');
                return;
            }

            const taskData = {
                taskNumber,
                description,
                videoSourceId: parseInt(videoSourceId),
                algorithm,
                status: 'stopped'
            };

            if (editingTaskId) {
                // 编辑模式
                axios.put(`/api/tasks/${editingTaskId}`, taskData)
                    .then(response => {
                        if (response.data.status === 'success') {
                            alert('任务更新成功');
                            closeModal();
                            loadTasks();
                        } else {
                            alert('任务更新失败: ' + response.data.message);
                        }
                    })
                    .catch(error => {
                        console.error('更新任务失败:', error);
                        alert('任务更新失败，请检查网络连接');
                    });
            } else {
                // 新增模式
                axios.post('/api/tasks', taskData)
                    .then(response => {
                        if (response.data.status === 'success') {
                            alert('任务添加成功');
                            closeModal();
                            loadTasks();
                        } else {
                            alert('任务添加失败: ' + response.data.message);
                        }
                    })
                    .catch(error => {
                        console.error('添加任务失败:', error);
                        alert('任务添加失败，请检查网络连接');
                    });
            }
        }

        // 启动任务
        function startTask(id) {
            if (!confirm('确定要启动这个任务吗？')) {
                return;
            }

            axios.post(`/api/tasks/${id}/start`)
                .then(response => {
                    if (response.data.status === 'success') {
                        alert('任务启动成功');
                        // 重新加载通道列表和任务列表
                        loadChannels().then(() => {
                            loadTasks();
                        });
                    } else {
                        alert('任务启动失败: ' + response.data.message);
                    }
                })
                .catch(error => {
                    console.error('启动任务失败:', error);
                    alert('任务启动失败，请检查网络连接');
                });
        }

        // 停止任务
        function stopTask(id) {
            if (!confirm('确定要停止这个任务吗？')) {
                return;
            }

            axios.post(`/api/tasks/${id}/stop`)
                .then(response => {
                    if (response.data.status === 'success') {
                        alert('任务停止成功');
                        // 重新加载通道列表和任务列表
                        loadChannels().then(() => {
                            loadTasks();
                        });
                    } else {
                        alert('任务停止失败: ' + response.data.message);
                    }
                })
                .catch(error => {
                    console.error('停止任务失败:', error);
                    alert('任务停止失败，请检查网络连接');
                });
        }

        // 删除任务
        function deleteTask(id) {
            if (!confirm('确定要删除这个任务吗？')) {
                return;
            }

            axios.delete(`/api/tasks/${id}`)
                .then(response => {
                    if (response.data.status === 'success') {
                        alert('任务删除成功');
                        loadTasks();
                    } else {
                        alert('任务删除失败: ' + response.data.message);
                    }
                })
                .catch(error => {
                    console.error('删除任务失败:', error);
                    alert('任务删除失败，请检查网络连接');
                });
        }

        // 点击模态框外部关闭
        document.getElementById('taskModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>

</html>
